# Установка Hysteria 2 в Docker

Это руководство поможет вам установить и настроить сервер Hysteria 2 на вашем сервере с использованием Docker.

Hysteria - это многофункциональная прокси-утилита, основанная на модифицированном протоколе QUIC. Она обеспечивает высокую производительность, устойчивость к цензуре и маскировку трафика.

## Предварительные требования

- Сервер под управлением Linux (например, Ubuntu 20.04 или новее).
- Установленный [Docker](https://docs.docker.com/engine/install/).
- Базовые навыки работы в командной строке Linux.

## Шаг 1: Создание необходимых файлов и директорий

Сначала создадим директорию для хранения конфигурации Hysteria и SSL-сертификата.

```bash
mkdir /etc/hysteria
cd /etc/hysteria
```

Теперь создайте конфигурационный файл `config.yaml`:

```bash
nano /etc/hysteria/config.yaml
```

Вставьте в него следующую конфигурацию:

```yaml
# Порт, на котором будет работать сервер Hysteria 2
# Убедитесь, что этот порт открыт в вашем брандмауэре (UDP)
listen: :43443

# Настройки TLS. Мы будем использовать самоподписанный сертификат.
tls:
  cert: /etc/hysteria/cert.pem
  key: /etc/hysteria/key.pem

# Настройки аутентификации. Замените "YOUR_STRONG_PASSWORD" на ваш надежный пароль.
auth:
  type: password
  password: "YOUR_STRONG_PASSWORD"

# Маскировка трафика (опционально, но рекомендуется)
# Трафик будет выглядеть как запрос к https://bing.com
masquerade:
  type: proxy
  proxy:
    url: https://bing.com
    rewriteHost: true
```

Сохраните и закройте файл (в `nano` это `Ctrl+X`, затем `Y` и `Enter`).

## Шаг 2: Создание самоподписанного SSL-сертификата

Для работы Hysteria 2 требуется SSL-сертификат. Если у вас нет домена, вы можете сгенерировать самоподписанный сертификат.

Выполните следующую команду, находясь в директории `/etc/hysteria`:

```bash
openssl ecparam -genkey -name prime256v1 -out key.pem
openssl req -new -x509 -days 3650 -key key.pem -out cert.pem -subj "/CN=bing.com"
```
Эта команда создаст два файла: `key.pem` (приватный ключ) и `cert.pem` (сертификат), которые будут действительны в течение 10 лет. В качестве `CN` (Common Name) мы используем `bing.com`, чтобы соответствовать настройкам маскировки.

## Шаг 3: Запуск Docker-контейнера

Теперь, когда у нас есть конфигурация и сертификат, мы можем запустить Hysteria 2 в Docker-контейнере.

Выполните следующую команду:

```bash
docker run -d \
  --name hysteria-server \
  --restart=always \
  -v /etc/hysteria:/etc/hysteria \
  -p 43443:43443/udp \
  tobyxdd/hysteria -c /etc/hysteria/config.yaml server
```

Разберем команду:
- `docker run -d`: Запускает контейнер в фоновом (detached) режиме.
- `--name hysteria-server`: Присваивает контейнеру имя `hysteria-server` для удобства управления.
- `--restart=always`: Автоматически перезапускает контейнер при сбое или после перезагрузки сервера.
- `-v /etc/hysteria:/etc/hysteria`: Монтирует нашу директорию с конфигурацией и сертификатами внутрь контейнера.
- `-p 43443:43443/udp`: Пробрасывает порт `43443` с хоста в контейнер по протоколу UDP.
- `tobyxdd/hysteria`: Имя Docker-образа.
- `-c /etc/hysteria/config.yaml server`: Указывает контейнеру запустить Hysteria в режиме сервера, используя наш конфигурационный файл.

## Шаг 4: Проверка статуса и логов

Чтобы убедиться, что контейнер успешно запустился, выполните:

```bash
docker ps
```

Вы должны увидеть контейнер с именем `hysteria-server` в списке.

Для просмотра логов сервера используйте команду:

```bash
docker logs -f hysteria-server
```

## Шаг 5: Настройка брандмауэра

Не забудьте открыть порт `43443/udp` в вашем брандмауэре. Если вы используете `ufw`:

```bash
ufw allow 43443/udp
ufw reload
```

## Пример конфигурации клиента

Чтобы подключиться к вашему серверу, клиенту Hysteria 2 потребуется следующая конфигурация (обычно это файл `config.json`):

```json
{
  "server": "YOUR_SERVER_IP:43443",
  "auth": "YOUR_STRONG_PASSWORD",
  "tls": {
    "sni": "bing.com",
    "insecure": true
  }
}
```

- `YOUR_SERVER_IP`: Замените на реальный IP-адрес вашего сервера.
- `YOUR_STRONG_PASSWORD`: Укажите тот же пароль, что и в `config.yaml` на сервере.
- `"insecure": true`: Этот параметр необходим, так как мы используем самоподписанный сертификат.

Готово! Ваш сервер Hysteria 2 настроен и готов к работе.

### UPD: Продвинутая маскировка

Стандартная конфигурация, описанная выше, уже обеспечивает базовый уровень маскировки, заставляя трафик выглядеть как обычный HTTPS (HTTP/3) трафик к популярному ресурсу. Однако, для более надежной защиты от современных систем анализа трафика (DPI), которые могут определять паттерны QUIC, можно применить более продвинутые методы.

#### 1. Обфускация "Salamander"

Hysteria 2 имеет встроенный механизм обфускации под названием "Salamander". Он трансформирует пакеты QUIC таким образом, что они выглядят как случайный, не имеющий структуры набор байт. Это делает практически невозможным определение протокола с помощью сигнатурного анализа.

Чтобы включить Salamander, добавьте в ваш серверный `config.yaml` следующие строки:

```yaml
# ... (ваши настройки listen, tls, auth)

obfs:
  type: salamander
  password: "YOUR_OBFS_PASSWORD"

masquerade:
  type: proxy
  proxy:
    url: https://bing.com
    rewriteHost: true
```

- `YOUR_OBFS_PASSWORD`: Замените на ваш собственный надежный пароль для обфускации. **Этот пароль не должен совпадать с паролем аутентификации.**

Соответственно, конфигурация клиента (`config.json`) также должна быть обновлена:

```json
{
  "server": "YOUR_SERVER_IP:43443",
  "auth": "YOUR_STRONG_PASSWORD",
  "obfs": "YOUR_OBFS_PASSWORD",
  "tls": {
    "sni": "bing.com",
    "insecure": true
  }
}
```
В клиенте пароль обфускации указывается в поле `"obfs"`.

#### 2. Использование реального домена и веб-сервера

Наиболее эффективный способ маскировки — это использование сервера, который не отличим от обычного веб-сервера.

1.  **Купите доменное имя** и направьте его A-запись на IP-адрес вашего сервера.
2.  **Используйте валидный SSL-сертификат**, например, от Let's Encrypt, вместо самоподписанного. Это уберет необходимость в опции `"insecure": true` на клиенте и сделает TLS-рукопожатие неотличимым от рукопожатия с реальным сайтом.
3.  **Настройте полноценный веб-сервер** (например, Nginx или Caddy) на том же порту, который будет отдавать настоящий веб-сайт. Hysteria будет работать "за" этим веб-сервером, и только клиенты с правильным паролем смогут установить прокси-соединение. Для всех остальных это будет выглядеть как обычный веб-сервер с поддержкой HTTP/3.

Такая конфигурация требует более глубоких знаний в администрировании, но обеспечивает максимальный уровень маскировки.
Hysteria может работать совместно с веб-серверами, которые поддерживают проксирование QUIC-трафика.

## Клиенты для Hysteria 2

Для подключения к серверу Hysteria 2 можно использовать различные клиентские приложения. Ниже приведен список рекомендованных клиентов для основных операционных систем.

### 1. Android
Для Android рекомендуется использовать сторонние приложения, так как официального клиента с графическим интерфейсом нет.
*   **NekoBox for Android:** Универсальный и популярный прокси-клиент.
*   **Hiddify Next:** Кроссплатформенный клиент с автоматической настройкой прокси.
*   **Clash.Meta for Android:** Мощное приложение, основанное на правилах.
*   **sing-box:** Универсальная прокси-платформа (для продвинутых пользователей).

### 2. Linux
Hysteria 2 официально предоставляет готовые исполняемые файлы для командной строки. Также существуют сторонние клиенты с графическим интерфейсом (GUI).
*   **Официальный CLI-клиент:** Загружается с GitHub, предлагает максимальную производительность и гибкость.
*   **NekoRay:** Популярный кроссплатформенный GUI-клиент.
*   **Hiddify Next:** Кроссплатформенный клиент с графическим интерфейсом.
*   **Furious:** Еще один кроссплатформенный GUI-клиент.

### 3. iOS
Поддержка Hysteria 2 на iOS осуществляется через сторонние приложения из App Store.
*   **Shadowrocket:** Очень популярное и многофункциональное прокси-приложение.
*   **Loon:** Мощный сетевой инструмент с поддержкой Hysteria 2.
*   **Pharos Pro:** Мультипротокольный прокси-клиент.
*   **Egern:** Приложение с богатым набором сетевых инструментов.

### 4. Windows
Для Windows доступен как официальный исполняемый файл, так и несколько удоб��ых клиентов с графическим интерфейсом.
*   **Официальный CLI-клиент:** Исполняемый `.exe` файл для запуска из командной строки.
*   **NekoRay:** Популярный GUI-клиент, работающий и на Windows.
*   **v2rayN:** Известный клиент, который также поддерживает Hysteria 2.
*   **Hiddify Next:** Кроссплатформенный клиент, доступный для Windows.

---

### Настройка клиента NekoBox for Android

Это пошаговое руководство поможет вам настроить Hysteria 2 в приложении NekoBox.

1.  **Откройте NekoBox и добавьте новый профиль.**
    *   Нажмите на иконку **"+"** в правом верхнем углу.
    *   Выберите в меню **"Ручной ввод [Hysteria]"**.

2.  **Введите данные вашего сервера.**
    *   **Имя профиля:** Введите любое удобное имя.
    *   **Версия прот��кола:** Выберите **"2"**.
    *   **Адрес сервера:** Введите IP-адрес или домен вашего сервера.
    *   **Порт сервера:** Укажите порт, который вы настроили на сервере (например, `43443`).
    *   **Пароль аутентификации:** Введите ваш пароль (`YOUR_STRONG_PASSWORD`).
    *   **Пароль обфускации:** Если вы включили `obfs` на сервере, введите здесь `YOUR_OBFS_PASSWORD`.

3.  **Настройте параметры TLS.**
    *   **SNI (Server Name Indication):** Укажите значение, которое соответствует `CN` в вашем сертификате (в нашем примере это `bing.com`).
    *   **Небезопасно:** Включите эту опцию (`true`), так как мы используем самоподписанный сертификат.

4.  **Сохраните и подключитесь.**
    *   Нажмите на иконку сохранения (обычно галочка) в правом верхнем углу.
    *   Вернувшись на главный экран, выберите созданный профиль.
    *   Нажмите на кнопку подключения (круглая иконка) внизу экрана.

После успешного подключения статус изменится на "Подключено", и ваш трафик будет маршрутизироваться через сервер Hysteria 2.
