# Установка Hysteria 2 в Docker

Это руководство поможет вам установить и настроить сервер Hysteria 2 на вашем сервере с использованием Docker.

Hysteria - это многофункциональная прокси-утилита, основанная на модифицированном протоколе QUIC. Она обеспечивает высокую производительность, устойчивость к цензуре и маскировку трафика.

## Предварительные требования

- Сервер под управлением Linux (например, Ubuntu 20.04 или новее).
- Установленный [Docker](https://docs.docker.com/engine/install/).
- Базовые навыки работы в командной строке Linux.

## Шаг 1: Создание необходимых файлов и директорий

Сначала создадим директорию для хранения конфигурации Hysteria и SSL-сертификата.

```bash
mkdir /etc/hysteria
cd /etc/hysteria
```

Теперь создайте конфигурационный файл `config.yaml`:

```bash
nano /etc/hysteria/config.yaml
```

Вставьте в него следующую конфигурацию:

```yaml
# Порт, на котором будет работать сервер Hysteria 2
# Убедитесь, что этот порт открыт в вашем брандмауэре (UDP)
listen: :43443

# Настройки TLS. Мы будем использовать самоподписанный сертификат.
tls:
  cert: /etc/hysteria/cert.pem
  key: /etc/hysteria/key.pem

# Настройки аутентификации. Замените "YOUR_STRONG_PASSWORD" на ваш надежный пароль.
auth:
  type: password
  password: "YOUR_STRONG_PASSWORD"

# Маскировка трафика (опционально, но рекомендуется)
# Трафик будет выглядеть как запрос к https://bing.com
masquerade:
  type: proxy
  proxy:
    url: https://bing.com
    rewriteHost: true
```

Сохраните и закройте файл (в `nano` это `Ctrl+X`, затем `Y` и `Enter`).

## Шаг 2: Создание самоподписанного SSL-сертификата

Для работы Hysteria 2 требуется SSL-сертификат. Если у вас нет домена, вы можете сгенерировать самоподписанный сертификат.

Выполните следующую команду, находясь в директории `/etc/hysteria`:

```bash
openssl ecparam -genkey -name prime256v1 -out key.pem
openssl req -new -x509 -days 3650 -key key.pem -out cert.pem -subj "/CN=bing.com"
```
Эта команда создаст два файла: `key.pem` (приватный ключ) и `cert.pem` (сертификат), которые будут действительны в течение 10 лет. В качестве `CN` (Common Name) мы используем `bing.com`, чтобы соответствовать настройкам маскировки.

## Шаг 3: Запуск Docker-контейнера

Теперь, когда у нас есть конфигурация и сертификат, мы можем запустить Hysteria 2 в Docker-контейнере.

Выполните следующую команду:

```bash
docker run -d \
  --name hysteria-server \
  --restart=always \
  -v /etc/hysteria:/etc/hysteria \
  -p 43443:43443/udp \
  tobyxdd/hysteria -c /etc/hysteria/config.yaml server
```

Разберем команду:
- `docker run -d`: Запускает контейнер в фоновом (detached) режиме.
- `--name hysteria-server`: Присваивает контейнеру имя `hysteria-server` для удобства управления.
- `--restart=always`: Автоматически перезапускает контейнер при сбое или после перезагрузки сервера.
- `-v /etc/hysteria:/etc/hysteria`: Монтирует нашу директорию с конфигурацией и сертификатами внутрь контейнера.
- `-p 43443:43443/udp`: Пробрасывает порт `43443` с хоста в контейнер по протоколу UDP.
- `tobyxdd/hysteria`: Имя Docker-образа.
- `-c /etc/hysteria/config.yaml server`: Указывает контейнеру запустить Hysteria в режиме сервера, используя наш конфигурационный файл.

## Шаг 4: Проверка статуса и логов

Чтобы убедиться, что контейнер успешно запустился, выполните:

```bash
docker ps
```

Вы должны увидеть контейнер с именем `hysteria-server` в списке.

Для просмотра логов сервера используйте команду:

```bash
docker logs -f hysteria-server
```

## Шаг 5: Настройка брандмауэра

Не забудьте открыть порт `43443/udp` в вашем брандмауэре. Если вы используете `ufw`:

```bash
ufw allow 43443/udp
ufw reload
```

## Пример конфигурации клиента

Чтобы подключиться к вашему серверу, клиенту Hysteria 2 потребуется следующая конфигурация (обычно это файл `config.json`):

```json
{
  "server": "YOUR_SERVER_IP:43443",
  "auth": "YOUR_STRONG_PASSWORD",
  "tls": {
    "sni": "bing.com",
    "insecure": true
  }
}
```

- `YOUR_SERVER_IP`: Замените на реальный IP-адрес вашего сервера.
- `YOUR_STRONG_PASSWORD`: Укажите тот же пароль, что и в `config.yaml` на сервере.
- `"insecure": true`: Этот параметр необходим, так как мы используем самоподписанный сертификат.

Готово! Ваш сервер Hysteria 2 настроен и готов к работе.
